# Zaoya CLI - Vibe Coding 实施计划

**版本**: v2.0 - CLI First Approach
**核心理念**: 先验证核心功能，再考虑 UI
**日期**: 2025-01-30

---

## 目录

1. [项目调整说明](#1-项目调整说明)
2. [CLI 工具核心功能](#2-cli-工具核心功能)
3. [技术架构 (CLI 版)](#3-技术架构-cli-版)
4. [实施路线图](#4-实施路线图)
5. [第一个迭代: MVP CLI](#5-第一个迭代-mvp-cli)
6. [数据结构设计](#6-数据结构设计)
7. [Agent 系统设计](#7-agent-系统设计)

---

## 1. 项目调整说明

### 1.1 调整原因

| 原计划 | 新计划 | 原因 |
|--------|--------|------|
| 直接开发移动端 | **先做 CLI 工具** | 快速验证核心价值 |
| 包含模板系统 | **暂不包含** | 降低复杂度，专注对话生成 |
| 包含前端界面 | **暂不包含** | 先验证后端 Agent 能力 |

### 1.2 新的开发顺序

```
Phase 1: CLI 工具 (当前)
  └── 验证: Interview Agent + Generation Agent 能否正常工作

Phase 2: Web 界面 (后续)
  └── 添加: React 前端 + 实时预览

Phase 3: 移动端 (未来)
  └── 优化: 移动端原生体验
```

### 1.3 保留的核心价值

- ✅ 对话式生成 (Vibe Coding)
- ✅ Interview Agent 主动提问
- ✅ 实时反馈循环
- ✅ 中文原生支持

---

## 2. CLI 工具核心功能

### 2.1 用户使用流程

```bash
# 1. 启动 CLI
$ zaoya chat

# 2. 与 AI 对话
你: 帮我做一个活动报名页面

AI: 好的！我想了解几个细节：
    1️⃣ 活动类型是什么？
    2️⃣ 需要收集什么信息？
    ...

你: 线下聚会，需要姓名电话和备注

AI: 明白了！开始生成...
    ✅ 生成完成！

# 3. 打开预览
AI: 已生成预览页面，打开查看：
    file:///Users/xxx/zaoya-preview.html

# 4. 在浏览器中查看
    (自动打开浏览器，显示生成的页面 + iframe 预览)

# 5. 继续优化
你: 把标题颜色改成红色

AI: 好的，修改中...
    ✅ 修改完成！刷新浏览器查看
```

### 2.2 CLI 命令设计

```bash
# 启动对话模式
$ zaoya chat

# 指定输出目录
$ zaoya chat --output ./my-project

# 从历史对话继续
$ zaoya chat --continue <session-id>

# 查看历史会话
$ zaoya history

# 打开上次生成的页面
$ zaoya open

# 导出代码
$ zaoya export --output ./dist

# 清理缓存
$ zaoya clean
```

### 2.3 核心输出物

**生成的 HTML 文件结构**:
```html
<!DOCTYPE html>
<html>
<head>
    <title>活动报名页面</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* 生成的样式 */
    </style>
</head>
<body>
    <!-- 生成的页面内容 -->
    <div class="container">
        <h1>活动报名</h1>
        <form>...</form>
    </div>

    <!-- Zaoya 预览控制栏 (可选，开发模式显示) -->
    <div id="zaoya-preview-bar" style="position: fixed; bottom: 0; ...">
        <span>Generated by Zaoya</span>
        <button onclick="zaoya.refresh()">刷新</button>
        <button onclick="zaoya.feedback()">反馈</button>
    </div>

    <script>
        // 生成的交互逻辑
    </script>
</body>
</html>
```

---

## 3. 技术架构 (CLI 版)

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────┐
│                    CLI 工具                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ 命令行界面   │  │ 文件系统     │  │ 浏览器启动   │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────┘
                        ↓ HTTP API
┌─────────────────────────────────────────────────────┐
│              FastAPI 后端服务                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ Chat API    │  │ Agent 系统   │  │ 页面生成器   │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│                 Agent 系统                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │ Interview   │  │ Generation  │  │ Refinement  │ │
│  │ Agent       │  │ Agent       │  │ Agent       │ │
│  └─────────────┘  └─────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│               Claude API                             │
└─────────────────────────────────────────────────────┘
```

### 3.2 核心组件 (High Level)

#### CLI 工具 (TypeScript/Node.js)
```
@zaoya/cli/
  - 命令行解析 (Commander.js)
  - 用户输入处理
  - 文件系统操作
  - 浏览器自动打开
  - 会话管理
```

#### 后端服务 (Python/FastAPI)
```
backend/
  - Chat API (处理对话)
  - Agent Orchestration
  - 页面生成逻辑
  - 会话存储 (SQLite)
```

#### Agent 系统
```
agents/
  - Interview Agent (需求澄清)
  - Generation Agent (生成页面)
  - Refinement Agent (优化迭代)
```

### 3.3 数据流

```
用户输入 (CLI)
  ↓
[CLI] 发送到后端 API
  ↓
[Backend] Chat API 接收
  ↓
[Agent] Interview Agent 分析
  ↓ (如需澄清)
[CLI] 展示问题
  ↓
用户回答
  ↓
[Agent] Generation Agent 生成 HTML
  ↓
[Backend] 保存到文件系统
  ↓
[CLI] 自动打开浏览器预览
  ↓
用户反馈
  ↓
[Agent] Refinement Agent 优化
  ↓
循环...
```

---

## 4. 实施路线图

### Phase 1: 核心 CLI (1-2 周)

**目标**: 基本的对话式生成功能

**功能清单**:
- [x] CLI 框架搭建
- [x] 基础命令 (`zaoya chat`)
- [x] 对话界面 (简单的命令行交互)
- [x] Interview Agent (基础版)
- [x] Generation Agent (简单 HTML 生成)
- [x] 文件输出 (生成 HTML 文件)
- [x] 浏览器自动打开

**验收标准**:
```bash
$ zaoya chat
你: 做一个个人介绍页面

AI: 好的！开始生成...
    ✅ 生成完成！

(自动打开浏览器，显示页面)
```

### Phase 2: 反馈循环 (1-2 周)

**目标**: 支持用户反馈和迭代优化

**功能清单**:
- [x] Refinement Agent
- [x] 用户反馈处理 (文字指令)
- [x] 增量更新 (不重新生成整个页面)
- [x] 会话历史保存
- [x] `zaoya history` 命令

**验收标准**:
```bash
$ zaoya chat
你: 把标题改成蓝色

AI: 好的，修改中...
    ✅ 修改完成！刷新浏览器查看
```

### Phase 3: 优化体验 (1 周)

**功能清单**:
- [x] 更好的 Interview Agent (多轮提问)
- [x] 更丰富的 HTML 生成 (表单、列表、卡片)
- [x] 错误处理和重试
- [x] 进度提示
- [x] 彩色输出 (更好的 CLI 体验)

### Phase 4: Web 前端 (后续阶段)

**不在此计划范围内**，未来考虑：
- React Web 界面
- 实时预览 (SSE)
- 移动端适配

---

## 5. 第一个迭代: MVP CLI

### 5.1 项目结构

```
zaoya/
├── packages/
│   ├── cli/                 # CLI 工具
│   │   ├── src/
│   │   │   ├── commands/
│   │   │   │   ├── chat.ts      # 主命令
│   │   │   │   ├── history.ts   # 历史命令
│   │   │   │   └── export.ts    # 导出命令
│   │   │   ├── utils/
│   │   │   │   ├── logger.ts    # 彩色输出
│   │   │   │   └── browser.ts   # 浏览器打开
│   │   │   └── index.ts
│   │   ├── package.json
│   │   └── tsconfig.json
│   │
│   └── backend/             # 后端服务
│       ├── app/
│       │   ├── main.py           # FastAPI 入口
│       │   ├── api/
│       │   │   └── chat.py        # Chat API
│       │   ├── agents/
│       │   │   ├── base.py        # Agent 基类
│       │   │   ├── interview.py   # Interview Agent
│       │   │   ├── generation.py  # Generation Agent
│       │   │   └── refinement.py  # Refinement Agent
│       │   ├── generators/
│       │   │   └── html.py        # HTML 生成器
│       │   └── storage/
│       │       ├── session.py     # 会话存储
│       │       └── filesystem.py  # 文件系统
│       ├── requirements.txt
│       └── pyproject.toml
│
├── .env.example               # 环境变量示例
├── package.json              # Monorepo 根配置
└── README.md
```

### 5.2 核心文件设计

#### CLI 主命令 (`cli/src/commands/chat.ts`)

```typescript
import { Command } from 'commander';
import axios from 'axios';
import open from 'open';
import chalk from 'chalk';
import ora from 'ora';

export const chatCommand = new Command('chat')
  .description('与 AI 对话生成网页')
  .option('-o, --output <dir>', '输出目录', './zaoya-output')
  .option('-c, --continue <id>', '继续之前的会话')
  .action(async (options) => {
    console.log(chalk.blue.bold('🎨 Zaoya CLI - Vibe Coding'));
    console.log(chalk.gray('输入 "exit" 或 "quit" 退出\n'));

    const sessionId = options.continue || generateSessionId();
    const outputDir = options.output;

    // 启动后端服务（如果未启动）
    await ensureBackendRunning();

    // 对话循环
    while (true) {
      const userInput = await prompt(chalk.green('你: '));

      if (userInput === 'exit' || userInput === 'quit') {
        console.log(chalk.yellow('再见！👋'));
        break;
      }

      // 显示加载动画
      const spinner = ora('AI 思考中...').start();

      try {
        // 发送到后端 API
        const response = await axios.post('http://localhost:8000/api/chat', {
          session_id: sessionId,
          message: userInput,
          output_dir: outputDir
        });

        spinner.stop();

        // 显示 AI 响应
        console.log(chalk.blue('\nAI: '), response.data.message);

        // 如果生成了页面，自动打开
        if (response.data.preview_url) {
          console.log(chalk.gray(`\n📂 预览: ${response.data.preview_url}`));
          await open(response.data.preview_url);
        }

      } catch (error) {
        spinner.stop();
        console.error(chalk.red('错误:'), error.message);
      }

      console.log();
    }
  });
```

#### Chat API (`backend/app/api/chat.py`)

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from agents.interview import InterviewAgent
from agents.generation import GenerationAgent
from agents.refinement import RefinementAgent

router = APIRouter()

class ChatRequest(BaseModel):
    session_id: str
    message: str
    output_dir: str = "./zaoya-output"

class ChatResponse(BaseModel):
    message: str
    preview_url: str | None = None
    action: str | None = None  # "clarify", "generate", "refine"

@router.post("/api/chat", response_model=ChatResponse)
async def chat(request: ChatRequest):
    # 获取会话状态
    session = get_session(request.session_id)

    # 判断 Agent 类型
    if session.phase == "interview":
        agent = InterviewAgent(session)
        response = await agent.process(request.message)

        if response.is_complete:
            # 进入生成阶段
            session.phase = "generation"
            return ChatResponse(
                message=response.message,
                action="generate"
            )
        else:
            # 继续提问
            return ChatResponse(
                message=response.message,
                action="clarify"
            )

    elif session.phase == "generation":
        agent = GenerationAgent(session)
        result = await agent.generate(request.message, request.output_dir)

        session.phase = "refinement"
        return ChatResponse(
            message=f"✅ 生成完成！预览: {result.preview_url}",
            preview_url=result.preview_url,
            action="refine"
        )

    elif session.phase == "refinement":
        agent = RefinementAgent(session)
        result = await agent.refine(request.message)

        return ChatResponse(
            message=f"✅ 修改完成！刷新浏览器查看",
            preview_url=result.preview_url,
            action="refine"
        )
```

#### Interview Agent (`backend/app/agents/interview.py`)

```python
from typing import Dict, List
from anthropic import Anthropic

class InterviewAgent:
    def __init__(self, session: Session):
        self.session = session
        self.client = Anthropic(api_key=get_api_key())
        self.questions_asked = session.get_context("questions_asked", [])

    async def process(self, user_input: str) -> InterviewResponse:
        """处理用户输入，决定是继续提问还是开始生成"""

        # 分析用户输入，判断信息是否足够
        prompt = self._build_prompt(user_input)

        response = self.client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=1000,
            messages=[
                {"role": "system", "content": self._system_prompt()},
                {"role": "user", "content": prompt}
            ]
        )

        ai_response = response.content[0].text

        # 判断是否需要继续提问
        decision = self._parse_decision(ai_response)

        if decision["needs_more_info"]:
            # 需要继续提问
            self.questions_asked.append(decision["question"])
            self.session.set_context("questions_asked", self.questions_asked)

            return InterviewResponse(
                message=decision["question"],
                is_complete=False
            )
        else:
            # 信息足够，可以开始生成
            summary = decision["summary"]
            self.session.set_context("project_summary", summary)

            return InterviewResponse(
                message=f"好的！明白了，开始为你生成 {summary['page_type']}...",
                is_complete=True
            )

    def _system_prompt(self) -> str:
        return """你是 Zaoya 的 Interview Agent，负责通过对话了解用户需求。

你的任务是：
1. 分析用户的输入
2. 判断信息是否足够生成一个网页
3. 如果信息不足，提出一个具体的、易于回答的问题
4. 如果信息足够，总结需求并标记为可以生成

你应该：
- 使用友好、日常的语言
- 一次只问一个问题
- 问题要具体，不要太抽象
- 用 Emoji 让对话更有亲和力

输出格式：
<decision>
<needs_more_info>true/false</needs_more_info>
<question>如果需要提问，在这里写问题</question>
<summary>
  <page_type>页面类型</page_type>
  <features>主要功能列表</features>
  <style>风格偏好</style>
</summary>
</decision>"""

    def _build_prompt(self, user_input: str) -> str:
        previous_qa = "\n".join([
            f"Q: {self.questions_asked[i]}\nA: {self.session.get_context('answers', {})[i]}"
            for i in range(len(self.questions_asked))
        ])

        return f"""用户想要做一个网页。

之前的对话：
{previous_qa}

用户最新的输入：
{user_input}

请判断信息是否足够，如果不够，提出下一个问题。"""
```

#### Generation Agent (`backend/app/agents/generation.py`)

```python
class GenerationAgent:
    def __init__(self, session: Session):
        self.session = session
        self.client = Anthropic(api_key=get_api_key())

    async def generate(self, user_input: str, output_dir: str) -> GenerationResult:
        """生成 HTML 页面"""

        # 获取项目摘要
        summary = self.session.get_context("project_summary")

        # 构建生成 prompt
        prompt = self._build_generation_prompt(summary, user_input)

        response = self.client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=4000,
            messages=[
                {"role": "system", "content": self._system_prompt()},
                {"role": "user", "content": prompt}
            ]
        )

        html_content = response.content[0].text

        # 保存到文件
        filepath = self._save_html(html_content, output_dir)

        # 返回预览 URL
        preview_url = f"file://{filepath}"

        return GenerationResult(
            html=html_content,
            preview_url=preview_url,
            filepath=filepath
        )

    def _system_prompt(self) -> str:
        return """你是 Zaoya 的 Generation Agent，负责生成高质量的 HTML 页面。

你的任务是：
1. 根据用户需求生成完整的 HTML 页面
2. 使用现代、移动端友好的设计
3. 代码要整洁、可维护
4. 使用内联 CSS 和 JavaScript（单文件）

技术要求：
- HTML5
- 移动端优先（Responsive Design）
- 现代浏览器兼容
- 无外部依赖（除了 Google Fonts）

输出格式：
直接输出完整的 HTML 代码，不要任何解释。"""

    def _save_html(self, html: str, output_dir: str) -> str:
        """保存 HTML 到文件"""
        from pathlib import Path
        import os

        # 创建输出目录
        Path(output_dir).mkdir(parents=True, exist_ok=True)

        # 生成文件名
        filepath = os.path.join(output_dir, "index.html")

        # 写入文件
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(html)

        return os.path.abspath(filepath)
```

---

## 6. 数据结构设计

### 6.1 Session (会话)

```python
from pydantic import BaseModel
from typing import Dict, Any, Optional
from datetime import datetime

class Session(BaseModel):
    session_id: str
    phase: Literal["interview", "generation", "refinement"]
    created_at: datetime
    updated_at: datetime
    context: Dict[str, Any] = {}
    messages: List[Dict[str, str]] = []

    def get_context(self, key: str, default: Any = None) -> Any:
        return self.context.get(key, default)

    def set_context(self, key: str, value: Any):
        self.context[key] = value
        self.updated_at = datetime.now()
```

### 6.2 InterviewResponse

```python
class InterviewResponse(BaseModel):
    message: str           # 展示给用户的消息
    is_complete: bool      # 是否可以进入生成阶段
```

### 6.3 GenerationResult

```python
class GenerationResult(BaseModel):
    html: str              # 生成的 HTML
    preview_url: str       # 预览 URL
    filepath: str          # 文件路径
```

---

## 7. Agent 系统设计

### 7.1 Agent 基类

```python
from abc import ABC, abstractmethod

class BaseAgent(ABC):
    def __init__(self, session: Session):
        self.session = session
        self.client = Anthropic(api_key=get_api_key())

    @abstractmethod
    async def process(self, user_input: str) -> Any:
        """处理用户输入"""
        pass
```

### 7.2 Agent 状态转换

```
Interview Agent
    ↓ (信息收集完成)
Generation Agent
    ↓ (页面生成完成)
Refinement Agent
    ↓ (持续迭代...)
```

---

## 8. 开发环境设置

### 8.1 依赖项

**CLI (TypeScript)**:
```json
{
  "dependencies": {
    "commander": "^12.0.0",
    "axios": "^1.6.0",
    "open": "^10.0.0",
    "chalk": "^5.3.0",
    "ora": "^8.0.0",
    "inquirer": "^9.2.0"
  }
}
```

**Backend (Python)**:
```txt
fastapi==0.109.0
uvicorn==0.27.0
anthropic==0.18.0
pydantic==2.5.0
python-dotenv==1.0.0
```

### 8.2 环境变量

```bash
# .env
ANTHROPIC_API_KEY=your_api_key_here
BACKEND_PORT=8000
OUTPUT_DIR=./zaoya-output
```

---

## 9. 下一步行动

### 9.1 立即开始 (本周)

1. **搭建项目结构**
   ```bash
   mkdir -p packages/{cli,backend}
   cd packages/cli && npm init -y
   cd packages/backend && python -m venv venv
   ```

2. **实现基础 CLI 框架**
   - Commander.js 配置
   - 基础命令定义
   - 彩色输出

3. **实现 Interview Agent**
   - Claude API 集成
   - 对话逻辑
   - 状态判断

### 9.2 第一个迭代目标

**2 周内实现**:
```bash
$ zaoya chat
🎨 Zaoya CLI - Vibe Coding
输入 "exit" 或 "quit" 退出

你: 帮我做一个活动报名页面

AI: 好的！我想了解几个细节：
    1️⃣ 这个活动是什么类型的？
    ...

你: 线下聚会

AI: 明白了！需要收集哪些信息？

你: 姓名、电话和备注

AI: 好的！开始生成...
    ✅ 生成完成！
    📂 预览: file:///Users/xxx/zaoya-output/index.html

(自动打开浏览器)
```

---

## 10. 成功标准

### 10.1 技术指标

| 指标 | 目标 |
|------|------|
| 生成时间 | < 30 秒 |
| Interview 轮次 | 2-5 轮 |
| HTML 质量 | 可直接使用 |
| 命令行体验 | 流畅、友好 |

### 10.2 用户验证

找到 3-5 个用户测试：
- 能否独立完成对话？
- 生成的页面是否可用？
- 是否愿意继续使用？

---

**文档版本**: v2.0 - CLI First
**最后更新**: 2025-01-30
**作者**: Zaoya 团队

---

## 总结

本文档重新定义了 Zaoya 的实施计划：

**核心变化**:
- ❌ 移除: 移动端、模板系统、前端界面
- ✅ 聚焦: CLI 工具 + Agent 系统 + 生成 HTML

**开发顺序**:
1. CLI 工具 (当前)
2. Web 界面 (后续)
3. 移动端 (未来)

**下一步**: 搭建项目结构，实现 Interview Agent
